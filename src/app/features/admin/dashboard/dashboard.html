<div class="dashboard-full">

  <!-- Navbar -->
  <header class="navbar">
    <div class="navbar-left">
      <div class="logo">
        <div class="logo-icon">E</div>
        <span class="logo-text">EgaBank</span>
      </div>
      <select class="navbar-dropdown">
        <option>Finance Dashboard</option>
      </select>
    </div>

    <div class="navbar-center">
      <div class="search-box">
        <i class="fas fa-search"></i>
        <input type="text" placeholder="Rechercher...">
      </div>
    </div>

    <div class="navbar-right">
      <button class="icon-btn notification-btn">
        <i class="fas fa-bell"></i>
        <span class="badge">3</span>
      </button>
      <div class="profile">
        <div class="profile-avatar">{{ currentUserInitials }}</div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <div class="dashboard-content">

    <!-- Top Row - 3 Cards -->
    <div class="top-cards">
      <div class="card visa-card">
        <div class="card-mini-header">
          <div class="card-title">
            <i class="fas fa-file-invoice-dollar card-icon"></i>
            <span class="card-label">Factures</span>
          </div>
        </div>
        <div class="visa-section">
          <div class="visa-logo">
            <i class="fab fa-cc-visa"></i>
            VISA
          </div>
          <div class="visa-text">Lié au compte principal</div>
          <div class="visa-number">
            <i class="fas fa-credit-card"></i>
            •••• 2710
          </div>
        </div>
        <div class="card-actions">
          <button class="card-btn active">
            <i class="fas fa-download"></i>
            Recevoir
          </button>
          <button class="card-btn">
            <i class="fas fa-paper-plane"></i>
            Envoyer
          </button>
        </div>
        <div class="balance-info">
          <i class="fas fa-calendar-alt"></i>
          <span class="balance-label">Frais mensuel: $50.00</span>
        </div>
      </div>

      <div class="card financial-card">
        <div class="card-mini-header">
          <div class="card-title">
            <i class="fas fa-chart-line card-icon"></i>
            <span class="card-label">Aperçu Financier</span>
          </div>
          <select class="card-dropdown">
            <option>Hebdomadaire</option>
            <option>Mensuel</option>
            <option>Annuel</option>
          </select>
        </div>
        <div class="financial-main">
          <div class="total-income">
            <span class="label">Revenu Total</span>
            <div class="income-value">
              <i class="fas fa-money-bill-wave"></i>
              <span class="value">{{ totalIncome | number:'1.2-2' }} FCFA</span>
            </div>
          </div>
          <div class="total-paid">
            <div class="paid-value">
              <i class="fas fa-hand-holding-usd"></i>
              <span class="value-paid">{{ totalPaid | number:'1.2-2' }} FCFA</span>
            </div>
            <span class="paid-label">Payé ce mois</span>
          </div>
        </div>
      </div>

      <div class="card performance-card">
        <div class="card-mini-header">
          <div class="card-title">
            <i class="fas fa-chart-bar card-icon"></i>
            <span class="card-label">Performance Mensuelle</span>
          </div>
        </div>
        <div class="table-container-small">
          <table class="performance-table">
            <thead>
            <tr>
              <th>Mois</th>
              <th>Revenu ($)</th>
              <th>Dépenses ($)</th>
              <th>Profit ($)</th>
            </tr>
            </thead>
            <tbody>
            <tr *ngFor="let row of monthlyPerformance">
              <td>{{ row.month }}</td>
              <td class="income-col">{{ row.income | number:'1.0-0' }}</td>
              <td class="expense-col">{{ row.expenses | number:'1.0-0' }}</td>
              <td [class]="row.profit >= 0 ? 'profit-col positive' : 'profit-col negative'">
                {{ row.profit | number:'1.0-0' }}
              </td>
            </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Charts Row -->
    <div class="charts-row">
      <div class="chart-card large">
        <div class="card-header">
          <h3>
            <i class="fas fa-chart-area"></i>
            Aperçu du Tableau de Bord
          </h3>
        </div>
        <div class="chart-container">
          <canvas #lineChart></canvas>
        </div>
      </div>

      <div class="chart-card small">
        <div class="card-header">
          <h3>
            <i class="fas fa-chart-pie"></i>
            Analyse de Croissance
          </h3>
        </div>
        <div class="gauge-container">
          <div class="gauge-circle">
            <svg viewBox="0 0 200 200">
              <circle cx="100" cy="100" r="80" fill="none" stroke="#2a2a2a" stroke-width="20"/>
              <circle cx="100" cy="100" r="80" fill="none" stroke="#000000" stroke-width="20"
                      stroke-dasharray="440" stroke-dashoffset="110"
                      transform="rotate(-90 100 100)"/>
            </svg>
            <div class="gauge-value">25%</div>
          </div>
          <div class="gauge-footer">
            <div class="gauge-info">
              <i class="fas fa-calendar"></i>
              <span class="gauge-label">Année sur année</span>
            </div>
            <span class="gauge-trend positive">
              <i class="fas fa-arrow-up"></i>
              +36%
            </span>
          </div>
        </div>
      </div>

      <div class="chart-card small">
        <div class="card-header">
          <h3>
            <i class="fas fa-coins"></i>
            Profits Annuels
          </h3>
        </div>
        <div class="chart-container">
          <canvas #doughnutChart></canvas>
        </div>
        <div class="chart-legend">
          <div class="legend-item">
            <span class="legend-color" style="background-color: #000000;"></span>
            <span>Compte Courant</span>
          </div>
          <div class="legend-item">
            <span class="legend-color" style="background-color: #333333;"></span>
            <span>Épargne</span>
          </div>
          <div class="legend-item">
            <span class="legend-color" style="background-color: #666666;"></span>
            <span>Investissement</span>
          </div>
        </div>
      </div>
    </div>

    <!-- SECTION CLIENTS -->
    <div class="activity-card">
      <div class="activity-header">
        <div class="activity-title">
          <i class="fas fa-users"></i>
          <span>Liste des Clients</span>
        </div>
        <div class="activity-actions">
          <button class="add-btn-primary" (click)="openClientModal()">
            <i class="fas fa-plus"></i>
            Ajouter un client
          </button>
        </div>
      </div>

      <div class="table-container">
        @if (loading) {
          <div class="loading-spinner">
            <div class="spinner"></div>
            <p>Chargement des clients...</p>
          </div>
        } @else if (clients.length === 0) {
          <div class="no-data">
            <i class="fas fa-users-slash"></i>
            <p>Aucun client trouvé</p>
          </div>
        } @else {
          <table class="activity-table">
            <thead>
            <tr>
              <th>Client</th>
              <th>Email</th>
              <th>Ville</th>
              <th>Nationalité</th>
              <th>Date de naissance</th>
              <th>Comptes</th>
              <th>Actions</th>
            </tr>
            </thead>
            <tbody>
              @for (client of clients; track client.id) {
                <tr class="table-row">
                  <td>
                    <div class="user-cell">
                      <div class="user-avatar">
                        {{ getInitials(client.firstName, client.lastName) }}
                      </div>
                      <div class="user-info">
                        <span class="user-name">{{ client.firstName }} {{ client.lastName }}</span>
                        <span class="user-id">ID: {{ client.id }}</span>
                      </div>
                    </div>
                  </td>
                  <td>{{ client.email }}</td>
                  <td>{{ client.city }}</td>
                  <td>{{ client.nationality }}</td>
                  <td>{{ client.dateNaissance | date:'dd/MM/yyyy' }}</td>
                  <td>{{ getClientComptesCount(client.id) }} compte(s)</td>
                  <td>
                    <div class="action-buttons">
                      <button class="action-icon delete" (click)="deleteClient(client.id)">
                        <i class="fas fa-trash"></i>
                      </button>
                    </div>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        }
      </div>
    </div>

    <!-- SECTION COMPTES -->
    <div class="activity-card">
      <div class="activity-header">
        <div class="activity-title">
          <i class="fas fa-wallet"></i>
          <span>Liste des Comptes</span>
        </div>
        <div class="activity-actions">
          <button class="add-btn-primary" (click)="openCompteModal()">
            <i class="fas fa-plus"></i>
            Créer un compte
          </button>
        </div>
      </div>

      <div class="table-container">
        @if (comptes.length === 0) {
          <div class="no-data">
            <i class="fas fa-wallet"></i>
            <p>Aucun compte trouvé</p>
          </div>
        } @else {
          <table class="activity-table">
            <thead>
            <tr>
              <th>N° Compte</th>
              <th>Type</th>
              <th>Solde</th>
              <th>Client</th>
              <th>Actions</th>
            </tr>
            </thead>
            <tbody>
              @for (compte of comptes; track compte.accountNumber) {
                <tr class="table-row">
                  <td><strong>{{ compte.accountNumber }}</strong></td>
                  <td class="income-col">{{ compte.sold | number:'1.2-2' }} FCFA</td>
                  <td>{{ compte.clientId }}</td>
                  <td>
                    <div class="action-buttons">
                      <button class="action-icon delete" (click)="deleteCompte(compte.accountNumber)">
                        <i class="fas fa-trash"></i>
                      </button>
                    </div>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        }
      </div>
    </div>

    <!-- SECTION TRANSACTIONS -->
    <div class="activity-card">
      <div class="activity-header">
        <div class="activity-title">
          <i class="fas fa-exchange-alt"></i>
          <span>Dernières Transactions</span>
        </div>
      </div>

      <div class="table-container">
        @if (allTransactions.length === 0) {
          <div class="no-data">
            <i class="fas fa-exchange-alt"></i>
            <p>Aucune transaction trouvée</p>
          </div>
        } @else {
          <table class="activity-table">
            <thead>
            <tr>
              <th>Date</th>
              <th>Type</th>
              <th>Montant</th>
              <th>N° Compte</th>
              <th>Description</th>
            </tr>
            </thead>
            <tbody>
              @for (transaction of allTransactions.slice(0, 10); track transaction.id) {
                <tr class="table-row">
                  <td>{{ transaction.dateTransaction | date:'dd/MM/yyyy HH:mm' }}</td>
                  <td>
                    <span [class]="transaction.typeTransaction === 'DEPOT' ? 'badge-success' : 'badge-danger'">
                      {{ transaction.typeTransaction }}
                    </span>
                  </td>
                  <td [class]="transaction.typeTransaction === 'DEPOT' ? 'income-col' : 'expense-col'">
                    {{ transaction.amount | number:'1.2-2' }} FCFA
                  </td>
                  <td>{{ transaction.description || '-' }}</td>
                </tr>
              }
            </tbody>
          </table>
        }
      </div>
    </div>

  </div>

  <!-- MODAL CLIENT -->
  <div class="modal-overlay" *ngIf="showClientModal" (click)="closeClientModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>
          <i class="fas fa-user-plus"></i>
          Nouveau Client
        </h2>
        <button class="close-btn" (click)="closeClientModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <!-- Progress Indicator -->
      <div class="progress-indicator">
        <div class="step" [class.active]="currentStep >= 1" [class.completed]="currentStep > 1">
          <div class="step-circle">
            <span *ngIf="currentStep > 1">✓</span>
            <span *ngIf="currentStep <= 1">1</span>
          </div>
          <span class="step-label">Identité</span>
        </div>
        <div class="step-line" [class.completed]="currentStep > 1"></div>
        <div class="step" [class.active]="currentStep >= 2" [class.completed]="currentStep > 2">
          <div class="step-circle">
            <span *ngIf="currentStep > 2">✓</span>
            <span *ngIf="currentStep <= 2">2</span>
          </div>
          <span class="step-label">Connexion</span>
        </div>
        <div class="step-line" [class.completed]="currentStep > 2"></div>
        <div class="step" [class.active]="currentStep >= 3">
          <div class="step-circle">3</div>
          <span class="step-label">Localisation</span>
        </div>
      </div>

      <form [formGroup]="clientForm" (ngSubmit)="submitClient()">
        <!-- Step 1 -->
        <div class="form-step" *ngIf="currentStep === 1">
          <div class="form-row">
            <div class="form-group">
              <label>Prénom *</label>
              <input type="text" formControlName="firstName" placeholder="Jean">
            </div>
            <div class="form-group">
              <label>Nom *</label>
              <input type="text" formControlName="lastName" placeholder="Dupont">
            </div>
          </div>
          <div class="form-group">
            <label>Date de naissance *</label>
            <input type="date" formControlName="dateNaissance">
          </div>
        </div>

        <!-- Step 2 -->
        <div class="form-step" *ngIf="currentStep === 2">
          <div class="form-group">
            <label>Email *</label>
            <input type="email" formControlName="email" placeholder="exemple@email.com">
          </div>
          <div class="form-group">
            <label>Mot de passe *</label>
            <input type="password" formControlName="password" placeholder="Min. 6 caractères">
          </div>
          <div class="form-group">
            <label>Confirmer mot de passe *</label>
            <input type="password" formControlName="confirmPassword">
          </div>
        </div>

        <!-- Step 3 -->
        <div class="form-step" *ngIf="currentStep === 3">
          <div class="form-group">
            <label>Ville *</label>
            <select formControlName="city">
              <option value="">Sélectionnez</option>
              <option value="Lomé">Lomé</option>
              <option value="Kara">Kara</option>
              <option value="Sokodé">Sokodé</option>
            </select>
          </div>
          <div class="form-group">
            <label>Nationalité *</label>
            <select formControlName="nationality">
              <option value="">Sélectionnez</option>
              <option value="Togolaise">Togolaise</option>
              <option value="Béninoise">Béninoise</option>
            </select>
          </div>
          <div class="form-group">
            <label>N° Pièce d'identité *</label>
            <input type="text" formControlName="numberNationality" placeholder="12345678">
          </div>
        </div>

        <div class="modal-actions">
          <button type="button" class="btn-secondary" *ngIf="currentStep > 1" (click)="previousStep()">
            Précédent
          </button>
          <button type="button" class="btn-primary" *ngIf="currentStep < totalSteps"
                  (click)="nextStep()" [disabled]="!isStepValid(currentStep)">
            Suivant
          </button>
          <button type="submit" class="btn-success" *ngIf="currentStep === totalSteps"
                  [disabled]="clientForm.invalid">
            Créer le client
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- MODAL COMPTE -->
  <div class="modal-overlay" *ngIf="showCompteModal" (click)="closeCompteModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>
          <i class="fas fa-wallet"></i>
          Nouveau Compte
        </h2>
        <button class="close-btn" (click)="closeCompteModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <form [formGroup]="compteForm" (ngSubmit)="submitCompte()">
        <div class="form-group">
          <label>Client *</label>
          <select formControlName="clientId">
            <option value="">Sélectionnez un client</option>
            <option *ngFor="let client of clients" [value]="client.id">
              {{ client.firstName }} {{ client.lastName }}
            </option>
          </select>
        </div>

        <div class="form-group">
          <label>Type de compte *</label>
          <select formControlName="accountType">
            <option value="COURANT">Courant</option>
            <option value="EPARGNE">Épargne</option>
          </select>
        </div>

        <div class="form-group">
          <label>Solde initial *</label>
          <input type="number" formControlName="initialBalance" placeholder="0">
        </div>

        <div class="modal-actions">
          <button type="button" class="btn-secondary" (click)="closeCompteModal()">
            Annuler
          </button>
          <button type="submit" class="btn-success" [disabled]="compteForm.invalid">
            Créer le compte
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- MODAL TRANSACTION -->
  <div class="modal-overlay" *ngIf="showTransactionModal" (click)="closeTransactionModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>
          <i class="fas fa-exchange-alt"></i>
          Nouvelle Transaction
        </h2>
        <button class="close-btn" (click)="closeTransactionModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <form [formGroup]="transactionForm" (ngSubmit)="submitTransaction()">
        <div class="form-group">
          <label>Compte *</label>
          <select formControlName="accountNumber">
            <option value="">Sélectionnez un compte</option>
            <option *ngFor="let compte of comptes" [value]="compte.accountNumber">
              {{ compte.accountNumber }} ({{ compte.sold | number:'1.2-2' }} FCFA)
            </option>
          </select>
        </div>

        <div class="form-group">
          <label>Type *</label>
          <select formControlName="typeTransaction">
            <option value="DEPOT">Dépôt</option>
            <option value="RETRAIT">Retrait</option>
          </select>
        </div>

        <div class="form-group">
          <label>Montant *</label>
          <input type="number" formControlName="amount" placeholder="0">
        </div>

        <div class="form-group">
          <label>Description</label>
          <input type="text" formControlName="description" placeholder="Optionnel">
        </div>

        <div class="modal-actions">
          <button type="button" class="btn-secondary" (click)="closeTransactionModal()">
            Annuler
          </button>
          <button type="submit" class="btn-success" [disabled]="transactionForm.invalid">
            Créer la transaction
          </button>
        </div>
      </form>
    </div>
  </div>

</div>
